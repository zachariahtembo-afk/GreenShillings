generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// GREENSHILLINGS - Advocacy-Led NGO Schema
// ============================================================================
// This schema supports an advocacy-focused NGO model, NOT a platform/marketplace.
// No investors, no farmers as users, no transactions, no balances, no ROI logic.
// ============================================================================

// Contact inquiries from website visitors
model ContactInquiry {
  id           String   @id @default(cuid())
  fullName     String
  email        String
  phone        String?
  organization String?
  role         String?
  message      String
  source       String?  // "mission", "problem", "model", "impact", "get-involved"
  createdAt    DateTime @default(now())

  @@index([createdAt])
  @@index([source])
}

// Pilot projects designed and executed by GREENSHILLINGS
model Project {
  id                  String      @id @default(cuid())
  name                String
  slug                String      @unique
  description         String
  location            String      // Geographic location (e.g., "Iringa District, Tanzania")
  projectType         String      // "agroforestry", "reforestation", "soil_carbon", "cookstoves"
  status              ProjectStatus @default(PLANNING)
  standardsAlignment  String[]    // ["Verra VCS", "Gold Standard", "Plan Vivo"]
  methodology         String?     // Specific methodology used
  startDate           DateTime?
  endDate             DateTime?
  targetHectares      Float?
  targetCO2e          Float?      // Target tonnes CO2e
  actualCO2e          Float?      // Verified tonnes CO2e
  impactSummary       String?
  lessonsLearned      String?
  imageUrl            String?
  documentUrls        String[]    // Links to project documents
  metadata            Json?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  communities         Community[]
  documents           Document[]
  proposals           Proposal[]
  @@index([status])
  @@index([projectType])
  @@index([location])
}

enum ProjectStatus {
  PLANNING
  ACTIVE
  COMPLETED
  ON_HOLD
}

// Communities engaged in GREENSHILLINGS projects
model Community {
  id                String    @id @default(cuid())
  name              String
  location          String
  district          String?
  region            String?
  populationEstimate Int?
  engagementModel   String?   // "co-design", "consultation", "implementation_partner"
  consentStatus     String?   // "pending", "obtained", "documented"
  consentDate       DateTime?
  primaryContact    String?
  contactPhone      String?
  notes             String?
  projectId         String?
  project           Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([projectId])
  @@index([district])
}

// Advocacy outputs: reports, briefings, analyses
model AdvocacyOutput {
  id              String   @id @default(cuid())
  title           String
  slug            String   @unique
  outputType      String   // "report", "briefing", "analysis", "position_paper", "case_study"
  topic           String   // "market_integrity", "community_benefits", "standards", "policy"
  audience        String   // "policymakers", "funders", "communities", "standards_bodies"
  summary         String
  fullContent     String?
  documentUrl     String?
  publicationDate DateTime
  authors         String[]
  isPublic        Boolean  @default(true)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([outputType])
  @@index([topic])
  @@index([publicationDate])
}

// Capital and knowledge partners (non-transactional relationships)
model CapitalPartner {
  id              String        @id @default(cuid())
  name            String
  partnerType     String        // "impact_investor", "foundation", "multilateral", "corporate", "government"
  engagementType  String        // "funder", "technical_partner", "knowledge_partner", "advisor"
  geography       String?       // Focus geography
  contactName     String?
  contactEmail    String?
  website         String?
  notes           String?       // Non-transactional relationship notes
  isActive        Boolean       @default(true)
  contacts        CRMContact[]
  interactions    Interaction[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([partnerType])
  @@index([engagementType])
}

// Partner organizations and portal users for document access
model PartnerOrganization {
  id             String                    @id @default(cuid())
  name           String
  slug           String                    @unique
  accessKeyId    String                    @unique
  accessKeyHash  String
  status         PartnerOrganizationStatus @default(ACTIVE)
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  users          PortalUser[]
  documentAccess DocumentAccess[]

  @@index([status])
}

model PortalUser {
  id              String          @id @default(cuid())
  email           String          @unique
  name            String
  role            PortalUserRole  @default(PARTNER)
  organizationId  String?
  organization    PartnerOrganization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  passwordHash    String?
  magicLinkToken  String?         @unique
  magicLinkExpiry DateTime?
  invitedAt       DateTime?
  lastLoginAt     DateTime?
  uploadedDocs    Document[]
  accessGrants    DocumentAccess[]
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([role])
  @@index([organizationId])
  @@index([magicLinkToken])
}

model Document {
  id             String             @id @default(cuid())
  title          String
  description    String?
  fileName       String
  storageKey     String
  contentType    String
  sizeBytes      Int?
  status         DocumentStatus     @default(DRAFT)
  version        String             @default("v01")
  category       String?
  standards      String[]
  methodologies  String[]
  tags           String[]
  visibility     DocumentVisibility @default(SELECTED)
  projectId      String?
  project        Project?           @relation(fields: [projectId], references: [id], onDelete: SetNull)
  uploadedById   String?
  uploadedBy     PortalUser?        @relation(fields: [uploadedById], references: [id], onDelete: SetNull)
  access         DocumentAccess[]
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@index([visibility])
}

model DocumentAccess {
  id             String               @id @default(cuid())
  documentId     String
  document       Document             @relation(fields: [documentId], references: [id], onDelete: Cascade)
  organizationId String
  organization   PartnerOrganization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  grantedAt      DateTime             @default(now())
  grantedById    String?
  grantedBy      PortalUser?          @relation(fields: [grantedById], references: [id], onDelete: SetNull)

  @@unique([documentId, organizationId])
  @@index([organizationId])
}

enum PortalUserRole {
  ADMIN
  STAFF
  PARTNER
}

enum PartnerOrganizationStatus {
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum DocumentStatus {
  DRAFT
  REVIEW
  FINAL
  ARCHIVED
}

enum DocumentVisibility {
  SELECTED
  ORGANIZATION
  PUBLIC
}

// ============================================================================
// DONOR NOTIFICATION SYSTEM
// ============================================================================
// Enables real-time SMS/WhatsApp notifications to donors when project
// milestones are reached, making "Direct-to-Community" funding feel immediate.
// ============================================================================

// Donor profiles for notification subscriptions
model Donor {
  id                    String               @id @default(cuid())
  email                 String               @unique
  fullName              String
  phone                 String?              // For SMS notifications
  whatsappNumber        String?              // For WhatsApp (may differ from SMS)
  preferredChannel      NotificationChannel  @default(EMAIL)
  notificationsEnabled  Boolean              @default(true)
  donationCount         Int                  @default(0)
  totalDonated          Float                @default(0)
  lastDonationAt        DateTime?
  metadata              Json?                // Store Stripe customer ID, etc.
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  subscriptions         DonorSubscription[]
  notifications         NotificationLog[]
  donations             Donation[]

  @@index([email])
  @@index([phone])
  @@index([notificationsEnabled])
}

enum NotificationChannel {
  EMAIL
  SMS
  WHATSAPP
  ALL
}

enum DonationFrequency {
  ONE_TIME
  MONTHLY
}

enum DonationStatus {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
  REFUNDED
}

model Donation {
  id        String            @id @default(cuid())
  donorId   String?
  donor     Donor?            @relation(fields: [donorId], references: [id], onDelete: SetNull)
  amount    Float
  currency  String
  status    DonationStatus    @default(PENDING)
  frequency DonationFrequency @default(ONE_TIME)
  metadata  Json?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([donorId])
  @@index([status])
  @@index([frequency])
}

// Donor subscriptions to specific projects
model DonorSubscription {
  id            String   @id @default(cuid())
  donorId       String
  donor         Donor    @relation(fields: [donorId], references: [id], onDelete: Cascade)
  projectId     String
  subscribedAt  DateTime @default(now())
  isActive      Boolean  @default(true)

  @@unique([donorId, projectId])
  @@index([projectId])
  @@index([isActive])
}

// Project milestones that trigger notifications
model ProjectMilestone {
  id              String            @id @default(cuid())
  projectId       String
  title           String            // "First 1,000 trees planted"
  description     String            // Detailed description for notifications
  milestoneType   MilestoneType
  targetValue     Float?            // e.g., 1000 for "1000 trees"
  achievedValue   Float?            // Actual value achieved
  achievedAt      DateTime?         // When milestone was reached
  imageUrl        String?           // Photo from the field
  location        String?           // GPS or location description
  isNotified      Boolean           @default(false)
  notifiedAt      DateTime?
  metadata        Json?             // Additional context (weather, participants, etc.)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  notifications   NotificationLog[]

  @@index([projectId])
  @@index([milestoneType])
  @@index([achievedAt])
  @@index([isNotified])
}

enum MilestoneType {
  TREES_PLANTED
  HECTARES_RESTORED
  COMMUNITY_TRAINED
  CARBON_VERIFIED
  HARVEST_COMPLETED
  PAYMENT_DISTRIBUTED
  MONITORING_COMPLETE
  CUSTOM
}

// Log of all notifications sent
model NotificationLog {
  id            String              @id @default(cuid())
  donorId       String
  donor         Donor               @relation(fields: [donorId], references: [id], onDelete: Cascade)
  milestoneId   String?
  milestone     ProjectMilestone?   @relation(fields: [milestoneId], references: [id], onDelete: SetNull)
  channel       NotificationChannel
  recipient     String              // Phone number or email
  messageBody   String
  status        NotificationStatus  @default(PENDING)
  externalId    String?             // Twilio SID or Resend ID
  errorMessage  String?
  sentAt        DateTime?
  deliveredAt   DateTime?
  createdAt     DateTime            @default(now())

  @@index([donorId])
  @@index([milestoneId])
  @@index([status])
  @@index([createdAt])
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

// ============================================================================
// AI CHAT SYSTEM
// ============================================================================
// Conversation logging and rate limiting for the AI assistant.
// Partners get unlimited access, public users have daily limits.
// ============================================================================

// Chat conversations for logging and analytics
model ChatConversation {
  id              String        @id @default(cuid())
  sessionId       String        // Browser session identifier
  visitorIp       String?       // For rate limiting (hashed)
  isPartner       Boolean       @default(false) // Partners get unlimited access
  partnerId       String?       // Link to partner if authenticated
  messageCount    Int           @default(0)
  tokensUsed      Int           @default(0)
  startedAt       DateTime      @default(now())
  lastMessageAt   DateTime      @default(now())
  escalatedAt     DateTime?     // When human handoff was requested
  escalationReason String?      // Why user requested human help
  metadata        Json?         // Browser info, referrer, etc.
  messages        ChatMessage[]

  @@index([sessionId])
  @@index([visitorIp])
  @@index([isPartner])
  @@index([startedAt])
  @@index([escalatedAt])
}

// Individual chat messages
model ChatMessage {
  id              String           @id @default(cuid())
  conversationId  String
  conversation    ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role            ChatRole
  content         String
  tokensUsed      Int?             // Tokens for this message
  createdAt       DateTime         @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

enum ChatRole {
  USER
  ASSISTANT
  SYSTEM
}

// Rate limiting tracking (per IP for public, unlimited for partners)
model ChatRateLimit {
  id            String   @id @default(cuid())
  identifier    String   @unique // IP hash or partner ID
  messageCount  Int      @default(0)
  windowStart   DateTime @default(now())
  isPartner     Boolean  @default(false)

  @@index([identifier])
  @@index([windowStart])
}

// ============================================================================
// PROPOSAL MANAGEMENT SYSTEM
// ============================================================================
// Internal team portal for managing funding proposals, tracking submissions,
// and retaining institutional knowledge.
// ============================================================================

model Proposal {
  id              String           @id @default(cuid())
  title           String
  description     String?
  fundingBody     String?          // Organization being applied to
  fundingTarget   Float?
  currency        String           @default("USD")
  status          ProposalStatus   @default(DRAFT)
  submittedBy     String           // Email of the team member who created it
  submittedByName String?          // Display name
  assignedTo      String?          // Team member responsible
  priority        String           @default("medium") // low, medium, high, urgent
  projectId       String?
  project         Project?         @relation(fields: [projectId], references: [id], onDelete: SetNull)
  documents       ProposalDocument[]
  interactions    Interaction[]
  notes           String?
  deadline        DateTime?
  submittedAt     DateTime?        // When formally submitted to funder
  analysisResult  Json?            // Databricks analysis output
  analysisStatus  String?          // "pending", "running", "completed", "failed"
  databricksRunId String?          // Tracks the Databricks job run
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([status])
  @@index([submittedBy])
  @@index([createdAt])
  @@index([priority])
}

enum ProposalStatus {
  DRAFT
  IN_REVIEW
  SUBMITTED
  APPROVED
  REJECTED
  ARCHIVED
}

model ProposalDocument {
  id          String   @id @default(cuid())
  proposalId  String
  proposal    Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  title       String
  fileName    String
  storageKey  String   // S3 key for the file
  contentType String
  sizeBytes   Int?
  uploadedAt  DateTime @default(now())

  @@index([proposalId])
}

// ============================================================================
// CRM - CONTACT & INTERACTION TRACKING
// ============================================================================
// Internal CRM for tracking relationships with funders, partners,
// and stakeholders. Linked to CapitalPartner organizations and Proposals.
// ============================================================================

model CRMContact {
  id           String         @id @default(cuid())
  name         String
  email        String?
  phone        String?
  title        String?        // Job title / role at their organization
  partnerId    String?
  partner      CapitalPartner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  interactions Interaction[]
  notes        String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([partnerId])
  @@index([email])
}

model Interaction {
  id          String          @id @default(cuid())
  type        InteractionType
  subject     String
  notes       String?
  date        DateTime        @default(now())
  loggedBy    String          // Email of team member who logged it
  contactId   String?
  contact     CRMContact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)
  partnerId   String?
  partner     CapitalPartner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  proposalId  String?
  proposal    Proposal?       @relation(fields: [proposalId], references: [id], onDelete: SetNull)
  createdAt   DateTime        @default(now())

  @@index([contactId])
  @@index([partnerId])
  @@index([proposalId])
  @@index([date])
  @@index([loggedBy])
}

enum InteractionType {
  MEETING
  CALL
  EMAIL
  NOTE
}
